---
title: "R Notebook"
output: html_notebook
---

```{r}
library(vegan)
library(ape)
library(dplyr)
library(tidyverse)
library(ggplot2)


# Load dataset from OSF repository
source(here::here(path = "scripts/0_data_import.R"))

traits_wide <- traits %>% pivot_wider(names_from = c(trait),
                                      values_from = c(value))

```


# Plot all data, site by elevation comparisons

Using 'site' rather than elevation for the plots, but in the analysis need the nested nature of plots within sites.

(Yes, we know we could make a function to not replicate plot code, we were just lazy/out of time)

```{r}

# Relevel SIte by elevation
traits_wide$site <- factor(traits_wide$site, 
                    levels = c("ACJ", "TRE", "QUE"))

(SLA_plot <- traits_wide %>%  
    ggplot() +
    geom_boxplot(aes(x = factor(treatment),
                     y = sla_cm2_g, fill = treatment), na.rm = TRUE) +
    # Choose manual colours
    scale_fill_manual(values = c("darkgreen", "orange"),
                      name = "Burn Treatment") +
    facet_wrap(site~.) +
    xlab(bquote(treatment)) +
    ylab(bquote(SLA_cm2_g)) +
    theme_classic() +
    theme(legend.position = "bottom"))

(PlantHeight_plot <- traits_wide %>%  
    ggplot() +
    geom_boxplot(aes(x = factor(treatment),
                     y = log(plant_height_cm), fill = treatment), na.rm = TRUE) +
    # Choose manual colours
    scale_fill_manual(values = c("darkgreen", "orange"),
                      name = "Burn Treatment") +
    facet_wrap(site~.) +
    xlab(bquote(treatment)) +
    ylab(bquote(log(Plant~Height,cm))) +
    theme_classic() +
    theme(legend.position = "bottom"))


(LeafArea_plot <- traits_wide %>%  
    ggplot() +
    geom_boxplot(aes(x = factor(treatment),
                     y = log(leaf_area_cm2), fill = treatment), na.rm = TRUE) +
    # Choose manual colours
    scale_fill_manual(values = c("darkgreen", "orange"),
                      name = "Burn Treatment") +
    facet_wrap(site~.) +
    xlab(bquote(treatment)) +
    ylab(bquote(log(Leaf~Area, cm2))) +
    theme_classic() +
    theme(legend.position = "bottom"))

(LeafThickness_plot <- traits_wide %>%  
    ggplot() +
    geom_boxplot(aes(x = factor(treatment),
                     y = log(leaf_thickness_mm), fill = treatment), na.rm = TRUE) +
    # Choose manual colours
    scale_fill_manual(values = c("darkgreen", "orange"),
                      name = "Burn Treatment") +
    facet_wrap(site~.) +
    xlab(bquote(treatment)) +
    ylab(bquote(log(Leaf~Thickness, mm))) +
    theme_classic() +
    theme(legend.position = "bottom"))

(LDMC_plot <- traits_wide %>%  
    ggplot() +
    geom_boxplot(aes(x = factor(treatment),
                     y = ldmc, fill = treatment), na.rm = TRUE) +
    # Choose manual colours
    scale_fill_manual(values = c("darkgreen", "orange"),
                      name = "Burn Treatment") +
    facet_wrap(site~.) +
    xlab(bquote(treatment)) +
    ylab(bquote(Leaf~Dry~Matter~Content)) +
    theme_classic() +
    theme(legend.position = "bottom"))


```

# Basic Analysis
```{r all_data_analysis}
library(lme4)
library(lmerTest)

# Models for all datasets (years, seasons)
# SLA
SLA_analysis <- lmer(log(sla_cm2_g) ~ treatment*elevation + (1|site/plot_id) + (1|family/taxon), data = traits_wide)
anova(SLA_analysis)

# Leaf Area
LA_analysis <- lmer(log(leaf_area_cm2) ~ treatment*elevation + (1|site/plot_id) + (1|family/taxon), data = traits_wide)
anova(LA_analysis)


# Plant Height
PlantHeight_analysis <- lmer(log(plant_height_cm) ~ treatment*elevation + (1|site/plot_id) + (1|family/taxon), data = traits_wide)
anova(PlantHeight_analysis)

# Leaf thickness
LeafThickness_analysis <- lmer(log(leaf_thickness_mm) ~ treatment*elevation + (1|site/plot_id) + (1|family/taxon), data = traits_wide)
anova(LeafThickness_analysis)

# LDMC
LDMC_analysis <- lmer(ldmc ~ treatment*elevation + (1|site/plot_id) + (1|family/taxon), data = traits_wide)
anova(LDMC_analysis)
```

# Dry season only plots and analysis

```{r}
# look at only dry season indices

traits_wide_dry <- traits_wide %>% 
  filter(c(season == "dry_season"))

(SLA_plot_dry <- traits_wide_dry %>%  
    ggplot() +
    geom_boxplot(aes(x = factor(treatment),
                     y = sla_cm2_g, fill = treatment), na.rm = TRUE) +
    # Choose manual colours
    scale_fill_manual(values = c("darkgreen", "orange"),
                      name = "Burn Treatment") +
    facet_wrap(site~.) +
    xlab(bquote(treatment)) +
    ylab(bquote(SLA_cm2_g)) +
    theme_classic() +
    theme(legend.position = "bottom"))

(PlantHeight_plot_dry <- traits_wide_dry %>%  
    ggplot() +
    geom_boxplot(aes(x = factor(treatment),
                     y = log(plant_height_cm), fill = treatment), na.rm = TRUE) +
    # Choose manual colours
    scale_fill_manual(values = c("darkgreen", "orange"),
                      name = "Burn Treatment") +
    facet_wrap(site~.) +
    xlab(bquote(treatment)) +
    ylab(bquote(log(Plant~Height,cm))) +
    theme_classic() +
    theme(legend.position = "bottom"))


(LeafArea_plot_dry <- traits_wide_dry %>%  
    ggplot() +
    geom_boxplot(aes(x = factor(treatment),
                     y = log(leaf_area_cm2), fill = treatment), na.rm = TRUE) +
    # Choose manual colours
    scale_fill_manual(values = c("darkgreen", "orange"),
                      name = "Burn Treatment") +
    facet_wrap(site~.) +
    xlab(bquote(treatment)) +
    ylab(bquote(log(Leaf~Area, cm2))) +
    theme_classic() +
    theme(legend.position = "bottom"))

(LeafThickness_plot_dry <- traits_wide_dry %>%  
    ggplot() +
    geom_boxplot(aes(x = factor(treatment),
                     y = log(leaf_thickness_mm), fill = treatment), na.rm = TRUE) +
    # Choose manual colours
    scale_fill_manual(values = c("darkgreen", "orange"),
                      name = "Burn Treatment") +
    facet_wrap(site~.) +
    xlab(bquote(treatment)) +
    ylab(bquote(log(Leaf~Thickness, mm))) +
    theme_classic() +
    theme(legend.position = "bottom"))

(LDMC_plot_dry <- traits_wide_dry %>%  
    ggplot() +
    geom_boxplot(aes(x = factor(treatment),
                     y = ldmc, fill = treatment), na.rm = TRUE) +
    # Choose manual colours
    scale_fill_manual(values = c("darkgreen", "orange"),
                      name = "Burn Treatment") +
    facet_wrap(site~.) +
    xlab(bquote(treatment)) +
    ylab(bquote(Leaf~Dry~Matter~Content)) +
    theme_classic() +
    theme(legend.position = "bottom"))


# Analysis

# SLA
SLA_analysis_dry <- lmer(log(sla_cm2_g) ~ treatment*elevation + (1|site/plot_id) + (1|family/taxon), data = traits_wide_dry)
anova(SLA_analysis_dry)

# Leaf Area
LA_analysis_dry <- lmer(log(leaf_area_cm2) ~ treatment*elevation + (1|site/plot_id) + (1|family/taxon), data = traits_wide_dry)
anova(LA_analysis_dry)


# Plant Height
PlantHeight_analysis_dry <- lmer(log(plant_height_cm) ~ treatment*elevation + (1|site/plot_id) + (1|family/taxon), data = traits_wide_dry)
anova(PlantHeight_analysis_dry)

# Leaf thickness
LeafThickness_analysis_dry <- lmer(log(leaf_thickness_mm) ~ treatment*elevation + (1|site/plot_id) + (1|family/taxon), data = traits_wide_dry)
anova(LeafThickness_analysis_dry)

# LDMC
LDMC_analysis_dry <- lmer(ldmc ~ treatment*elevation + (1|site/plot_id) + (1|family/taxon), data = traits_wide_dry)
anova(LDMC_analysis_dry)
```

# Wet season only plots and analysis

```{r}
# Analysis
traits_wide_wet <- traits_wide %>% 
  filter(c(season == "wet_season"))


(SLA_plot_wet <- traits_wide_wet %>%  
    ggplot() +
    geom_boxplot(aes(x = factor(treatment),
                     y = sla_cm2_g, fill = treatment), na.rm = TRUE) +
    # Choose manual colours
    scale_fill_manual(values = c("darkgreen", "orange"),
                      name = "Burn Treatment") +
    facet_wrap(site~.) +
    xlab(bquote(treatment)) +
    ylab(bquote(SLA_cm2_g)) +
    theme_classic() +
    theme(legend.position = "bottom"))

(PlantHeight_plot_wet <- traits_wide_wet %>%  
    ggplot() +
    geom_boxplot(aes(x = factor(treatment),
                     y = log(plant_height_cm), fill = treatment), na.rm = TRUE) +
    # Choose manual colours
    scale_fill_manual(values = c("darkgreen", "orange"),
                      name = "Burn Treatment") +
    facet_wrap(site~.) +
    xlab(bquote(treatment)) +
    ylab(bquote(log(Plant~Height,cm))) +
    theme_classic() +
    theme(legend.position = "bottom"))


(LeafArea_plot_wet <- traits_wide_wet %>%  
    ggplot() +
    geom_boxplot(aes(x = factor(treatment),
                     y = log(leaf_area_cm2), fill = treatment), na.rm = TRUE) +
    # Choose manual colours
    scale_fill_manual(values = c("darkgreen", "orange"),
                      name = "Burn Treatment") +
    facet_wrap(site~.) +
    xlab(bquote(treatment)) +
    ylab(bquote(log(Leaf~Area, cm2))) +
    theme_classic() +
    theme(legend.position = "bottom"))

(LeafThickness_plot_wet <- traits_wide_wet %>%  
    ggplot() +
    geom_boxplot(aes(x = factor(treatment),
                     y = log(leaf_thickness_mm), fill = treatment), na.rm = TRUE) +
    # Choose manual colours
    scale_fill_manual(values = c("darkgreen", "orange"),
                      name = "Burn Treatment") +
    facet_wrap(site~.) +
    xlab(bquote(treatment)) +
    ylab(bquote(log(Leaf~Thickness, mm))) +
    theme_classic() +
    theme(legend.position = "bottom"))

(LDMC_plot_wet <- traits_wide_wet %>%  
    ggplot() +
    geom_boxplot(aes(x = factor(treatment),
                     y = ldmc, fill = treatment), na.rm = TRUE) +
    # Choose manual colours
    scale_fill_manual(values = c("darkgreen", "orange"),
                      name = "Burn Treatment") +
    facet_wrap(site~.) +
    xlab(bquote(treatment)) +
    ylab(bquote(Leaf~Dry~Matter~Content)) +
    theme_classic() +
    theme(legend.position = "bottom"))




# SLA
SLA_analysis_wet <- lmer(log(sla_cm2_g) ~ treatment*elevation + (1|site/plot_id) + (1|family/taxon)+ (1|functional_group), data = traits_wide_wet)
anova(SLA_analysis_wet)

# Leaf Area
LA_analysis_wet <- lmer(log(leaf_area_cm2) ~ treatment*elevation + (1|site/plot_id) + (1|family/taxon)+ (1|functional_group), data = traits_wide_wet)
anova(LA_analysis_wet)


# Plant Height
PlantHeight_analysis_wet <- lmer(log(plant_height_cm) ~ treatment*elevation + (1|site/plot_id) + (1|family/taxon)+ (1|functional_group), data = traits_wide_wet)
anova(PlantHeight_analysis_wet)

# Leaf thickness
LeafThickness_analysis_wet <- lmer(log(leaf_thickness_mm) ~ treatment*elevation + (1|site/plot_id) + (1|family/taxon) + (1|functional_group), data = traits_wide_wet)
anova(LeafThickness_analysis_wet)

# LDMC
LDMC_analysis_wet <- lmer(ldmc ~ treatment*elevation + (1|site/plot_id) + (1|family/taxon)+ (1|functional_group), data = traits_wide_wet)
anova(LDMC_analysis_wet)
```


# Prelininary Look at Functional Groups (Wet Season Only)

```{r}
(SLA_plot_wet_FG <- traits_wide_wet %>%  
    ggplot() +
    geom_boxplot(aes(x = factor(functional_group),
                     y = sla_cm2_g, fill = treatment), na.rm = TRUE) +
    # Choose manual colours
    scale_fill_manual(values = c("darkgreen", "orange"),
                      name = "Burn Treatment") +
    facet_wrap(site~.) +
    xlab(bquote(Functional~Group)) +
    ylab(bquote(SLA_cm2_g)) +
    theme_classic() +
    theme(legend.position = "bottom"))

(PlantHeight_plot_wet_FG <- traits_wide_wet %>%  
    ggplot() +
    geom_boxplot(aes(x = factor(functional_group),
                     y = log(plant_height_cm), fill = treatment), na.rm = TRUE) +
    # Choose manual colours
    scale_fill_manual(values = c("darkgreen", "orange"),
                      name = "Burn Treatment") +
    facet_wrap(site~.) +
    xlab(bquote(Functional~Group)) +
    ylab(bquote(log(Plant~Height,cm))) +
    theme_classic() +
    theme(legend.position = "bottom"))


(LeafArea_plot_wet_FG <- traits_wide_wet %>%  
    ggplot() +
    geom_boxplot(aes(x = factor(functional_group),
                     y = log(leaf_area_cm2), fill = treatment), na.rm = TRUE) +
    # Choose manual colours
    scale_fill_manual(values = c("darkgreen", "orange"),
                      name = "Burn Treatment") +
    facet_wrap(site~.) +
    xlab(bquote(Functional~Group)) +
    ylab(bquote(log(Leaf~Area, cm2))) +
    theme_classic() +
    theme(legend.position = "bottom"))

(LeafThickness_plot_wet_FG <- traits_wide_wet %>%  
    ggplot() +
    geom_boxplot(aes(x = factor(functional_group),
                     y = log(leaf_thickness_mm), fill = treatment), na.rm = TRUE) +
    # Choose manual colours
    scale_fill_manual(values = c("darkgreen", "orange"),
                      name = "Burn Treatment") +
    facet_wrap(site~.) +
    xlab(bquote(Functional~Group)) +
    ylab(bquote(log(Leaf~Thickness, mm))) +
    theme_classic() +
    theme(legend.position = "bottom"))

(LDMC_plot_wet <- traits_wide_wet %>%  
    ggplot() +
    geom_boxplot(aes(x = factor(functional_group),
                     y = ldmc, fill = treatment), na.rm = TRUE) +
    # Choose manual colours
    scale_fill_manual(values = c("darkgreen", "orange"),
                      name = "Burn Treatment") +
    facet_wrap(site~.) +
    xlab(bquote(Functional~Group)) +
    ylab(bquote(Leaf~Dry~Matter~Content)) +
    theme_classic() +
    theme(legend.position = "bottom"))

```

